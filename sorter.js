import { TFolder, TFile } from "obsidian";
import SettingsUtils from "settingsUtils";
export default class Sorter {
    static startSorting(fileExpView, settings) {
        this.fileExpView = fileExpView;
        this.settings = settings;
        this.sort();
    }
    // modified from js source code
    static sort() {
        if (!this.fileExpView.ready || !this.fileExpView.containerEl.isShown())
            return;
        const vault = this.fileExpView.app.vault;
        // source code from js
        const itemArr = this.fileExpView.fileItems;
        const tree = this.fileExpView.tree;
        const navContainer = this.fileExpView.navFileContainerEl;
        const scrollTop = navContainer.scrollTop;
        // init all folder
        this.fileWeightsByFolder = {};
        this.fileWeightsByFolder[vault.getRoot().path] = {};
        const folderItemArr = [];
        for (const k in itemArr) {
            const item = itemArr[k];
            const folderOr = item.file;
            // expect folder
            if (!(itemArr.hasOwnProperty(k) && folderOr && (folderOr instanceof TFolder)))
                continue;
            folderItemArr.push(item);
            this.fileWeightsByFolder[folderOr.path] = {};
        }
        // gen all weights
        this.genWeightsByPath(vault.getRoot());
        for (const folderItem of folderItemArr) {
            // definitely a folder
            this.genWeightsByPath(folderItem.file);
        }
        // sort all by weight
        tree.infinityScroll.rootEl.vChildren.setChildren(this.getSortedFolderItems(vault.getRoot()));
        for (const folderItem of folderItemArr) {
            folderItem.vChildren.setChildren(this.getSortedFolderItems(folderItem.file));
        }
        // debug
        // console.log(this.fileWeightsByFolder)
        navContainer.scrollTop = scrollTop;
        tree.infinityScroll.compute();
        // deleted !isShown source code, do nothing
    }
    static genWeightsByPath(folder) {
        const weightByPath = this.fileWeightsByFolder[folder.path];
        // iterate files in folder
        for (const file of folder.children) {
            const weight = (() => {
                if (file instanceof TFolder)
                    return this.settings.weightForFolder; // default for folder
                if (!(file instanceof TFile) || (file.extension !== 'md')) { // not file or file not .md
                    return this.settings.weightForOtherFile;
                }
                if (file.name === 'index.md') { // index.md, set weight of folder in folder.parent
                    if (file.parent) {
                        // override default weight of folder
                        this.fileWeightsByFolder[file.parent.path][file.path] = this.getWeightOfMd(file);
                    }
                    return this.settings.weightForIndex;
                }
                // normal .md
                return this.getWeightOfMd(file);
            })();
            // don't override exist weight(folder)
            if (!weightByPath[file.path])
                weightByPath[file.path] = weight;
        }
    }
    static getWeightOfMd(file) {
        // any file with extension ".md" own its cachedMetadata, even it's not a markdown file !!!
        // empty markdown: cachedMetadata = {} ( {} = true )
        const cachedMetadata = this.fileExpView.app.metadataCache.getFileCache(file);
        const frontmatter = cachedMetadata.frontmatter;
        if (!frontmatter)
            return this.settings.weightForMarkdownFile;
        const rawWeight = frontmatter[this.settings.sortKey];
        return SettingsUtils.getInputOrDflt(String(rawWeight), 'weightForMarkdownFile');
    }
}
Sorter.getSortedFolderItems = function (folder) {
    const weightByPath = this.fileWeightsByFolder[folder.path];
    const children = folder.children.slice();
    children.sort((a, b) => { return weightByPath[a.path] - weightByPath[b.path]; });
    const sortedItems = [];
    for (const child of children) {
        sortedItems.push(this.fileExpView.fileItems[child.path]);
    }
    return sortedItems;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3JjL3NvcnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQW9CLE9BQU8sRUFBRSxLQUFLLEVBQThCLE1BQU0sVUFBVSxDQUFDO0FBQ3hGLE9BQU8sYUFBYSxNQUFNLGVBQWUsQ0FBQztBQUcxQyxNQUFNLENBQUMsT0FBTyxPQUFPLE1BQU07SUFNdkIsTUFBTSxDQUFDLFlBQVksQ0FBQyxXQUE2QixFQUFFLFFBQTBCO1FBQ3pFLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFBO1FBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFBO1FBRXhCLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQTtJQUNmLENBQUM7SUFFRCwrQkFBK0I7SUFDdkIsTUFBTSxDQUFDLElBQUk7UUFFZixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUU7WUFBRSxPQUFNO1FBRTlFLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQTtRQUV4QyxzQkFBc0I7UUFDdEIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUE7UUFDMUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUE7UUFDbEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQTtRQUN4RCxNQUFNLFNBQVMsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFBO1FBRXhDLGtCQUFrQjtRQUNsQixJQUFJLENBQUMsbUJBQW1CLEdBQUcsRUFBRSxDQUFBO1FBQzdCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFB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QyxDQUFDLENBQUE7S0FDM0Q7SUFDRCxPQUFPLFdBQVcsQ0FBQTtBQUN0QixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGaWxlRXhwbG9yZXJWaWV3LCBURm9sZGVyLCBURmlsZSwgRm9sZGVySXRlbSwgQ2FjaGVkTWV0YWRhdGEgfSBmcm9tIFwib2JzaWRpYW5cIjtcclxuaW1wb3J0IFNldHRpbmdzVXRpbHMgZnJvbSBcInNldHRpbmdzVXRpbHNcIjtcclxuaW1wb3J0IHsgTmF2ZWlnaHRTZXR0aW5ncyB9IGZyb20gXCJ0eXBlcy90eXBlc1wiO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU29ydGVyIHtcclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBmaWxlV2VpZ2h0c0J5Rm9sZGVyOiBSZWNvcmQ8c3RyaW5nLCBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+PlxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZmlsZUV4cFZpZXc6IEZpbGVFeHBsb3JlclZpZXdcclxuICAgIHByaXZhdGUgc3RhdGljIHNldHRpbmdzOiBOYXZlaWdodFNldHRpbmdzXHJcblxyXG4gICAgc3RhdGljIHN0YXJ0U29ydGluZyhmaWxlRXhwVmlldzogRmlsZUV4cGxvcmVyVmlldywgc2V0dGluZ3M6IE5hdmVpZ2h0U2V0dGluZ3MpIHtcclxuICAgICAgICB0aGlzLmZpbGVFeHBWaWV3ID0gZmlsZUV4cFZpZXdcclxuICAgICAgICB0aGlzLnNldHRpbmdzID0gc2V0dGluZ3NcclxuXHJcbiAgICAgICAgdGhpcy5zb3J0KClcclxuICAgIH1cclxuXHJcbiAgICAvLyBtb2RpZmllZCBmcm9tIGpzIHNvdXJjZSBjb2RlXHJcbiAgICBwcml2YXRlIHN0YXRpYyBzb3J0KCkge1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuZmlsZUV4cFZpZXcucmVhZHkgfHwgIXRoaXMuZmlsZUV4cFZpZXcuY29udGFpbmVyRWwuaXNTaG93bigpKSByZXR1cm5cclxuXHJcbiAgICAgICAgY29uc3QgdmF1bHQgPSB0aGlzLmZpbGVFeHBWaWV3LmFwcC52YXVsdFxyXG5cclxuICAgICAgICAvLyBzb3VyY2UgY29kZSBmcm9tIGpzXHJcbiAgICAgICAgY29uc3QgaXRlbUFyciA9IHRoaXMuZmlsZUV4cFZpZXcuZmlsZUl0ZW1zXHJcbiAgICAgICAgY29uc3QgdHJlZSA9IHRoaXMuZmlsZUV4cFZpZXcudHJlZVxyXG4gICAgICAgIGNvbnN0IG5hdkNvbnRhaW5lciA9IHRoaXMuZmlsZUV4cFZpZXcubmF2RmlsZUNvbnRhaW5lckVsXHJcbiAgICAgICAgY29uc3Qgc2Nyb2xsVG9wID0gbmF2Q29udGFpbmVyLnNjcm9sbFRvcFxyXG5cclxuICAgICAgICAvLyBpbml0IGFsbCBmb2xkZXJcclxuICAgICAgICB0aGlzLmZpbGVXZWlnaHRzQnlGb2xkZXIgPSB7fVxyXG4gICAgICAgIHRoaXMuZmlsZVdlaWdodHNCeUZvbGRlclt2YXVsdC5nZXRSb290KCkucGF0aF0gPSB7fVxyXG4gICAgICAgIGNvbnN0IGZvbGRlckl0ZW1BcnI6IEZvbGRlckl0ZW1bXSA9IFtdXHJcbiAgICAgICAgZm9yIChjb25zdCBrIGluIGl0ZW1BcnIpIHtcclxuICAgICAgICAgICAgY29uc3QgaXRlbSA9IGl0ZW1BcnJba11cclxuICAgICAgICAgICAgY29uc3QgZm9sZGVyT3IgPSBpdGVtLmZpbGVcclxuICAgICAgICAgICAgLy8gZXhwZWN0IGZvbGRlclxyXG4gICAgICAgICAgICBpZiAoIShpdGVtQXJyLmhhc093blByb3BlcnR5KGspICYmIGZvbGRlck9yICYmIChmb2xkZXJPciBpbnN0YW5jZW9mIFRGb2xkZXIpKSkgY29udGludWU7XHJcblxyXG4gICAgICAgICAgICBmb2xkZXJJdGVtQXJyLnB1c2goaXRlbSBhcyBGb2xkZXJJdGVtKVxyXG4gICAgICAgICAgICB0aGlzLmZpbGVXZWlnaHRzQnlGb2xkZXJbZm9sZGVyT3IucGF0aF0gPSB7fVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZ2VuIGFsbCB3ZWlnaHRzXHJcbiAgICAgICAgdGhpcy5nZW5XZWlnaHRzQnlQYXRoKHZhdWx0LmdldFJvb3QoKSlcclxuICAgICAgICBmb3IgKGNvbnN0IGZvbGRlckl0ZW0gb2YgZm9sZGVySXRlbUFycikge1xyXG4gICAgICAgICAgICAvLyBkZWZpbml0ZWx5IGEgZm9sZGVyXHJcbiAgICAgICAgICAgIHRoaXMuZ2VuV2VpZ2h0c0J5UGF0aChmb2xkZXJJdGVtLmZpbGUgYXMgVEZvbGRlcilcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHNvcnQgYWxsIGJ5IHdlaWdodFxyXG4gICAgICAgIHRyZWUuaW5maW5pdHlTY3JvbGwucm9vdEVsLnZDaGlsZHJlbi5zZXRDaGlsZHJlbih0aGlzLmdldFNvcnRlZEZvbGRlckl0ZW1zKHZhdWx0LmdldFJvb3QoKSkpXHJcbiAgICAgICAgZm9yIChjb25zdCBmb2xkZXJJdGVtIG9mIGZvbGRlckl0ZW1BcnIpIHtcclxuICAgICAgICAgICAgZm9sZGVySXRlbS52Q2hpbGRyZW4uc2V0Q2hpbGRyZW4odGhpcy5nZXRTb3J0ZWRGb2xkZXJJdGVtcyhmb2xkZXJJdGVtLmZpbGUpKVxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIC8vIGRlYnVnXHJcbiAgICAgICAgLy8gY29uc29sZS5sb2codGhpcy5maWxlV2VpZ2h0c0J5Rm9sZGVyKVxyXG5cclxuICAgICAgICBuYXZDb250YWluZXIuc2Nyb2xsVG9wID0gc2Nyb2xsVG9wXHJcbiAgICAgICAgdHJlZS5pbmZpbml0eVNjcm9sbC5jb21wdXRlKClcclxuXHJcbiAgICAgICAgLy8gZGVsZXRlZCAhaXNTaG93biBzb3VyY2UgY29kZSwgZG8gbm90aGluZ1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc3RhdGljIGdldFNvcnRlZEZvbGRlckl0ZW1zID0gZnVuY3Rpb24gKGZvbGRlcjogVEZvbGRlcikge1xyXG4gICAgICAgIGNvbnN0IHdlaWdodEJ5UGF0aCA9IHRoaXMuZmlsZVdlaWdodHNCeUZvbGRlcltmb2xkZXIucGF0aF1cclxuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IGZvbGRlci5jaGlsZHJlbi5zbGljZSgpO1xyXG4gICAgICAgIGNoaWxkcmVuLnNvcnQoKGEsIGIpID0+IHsgcmV0dXJuIHdlaWdodEJ5UGF0aFthLnBhdGhdIC0gd2VpZ2h0QnlQYXRoW2IucGF0aF07IH0pO1xyXG5cclxuICAgICAgICBjb25zdCBzb3J0ZWRJdGVtcyA9IFtdXHJcbiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiBjaGlsZHJlbikge1xyXG4gICAgICAgICAgICBzb3J0ZWRJdGVtcy5wdXNoKHRoaXMuZmlsZUV4cFZpZXcuZmlsZUl0ZW1zW2NoaWxkLnBhdGhdKVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gc29ydGVkSXRlbXNcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHN0YXRpYyBnZW5XZWlnaHRzQnlQYXRoKGZvbGRlcjogVEZvbGRlcikge1xyXG4gICAgICAgIGNvbnN0IHdlaWdodEJ5UGF0aCA9IHRoaXMuZmlsZVdlaWdodHNCeUZvbGRlcltmb2xkZXIucGF0aF1cclxuXHJcbiAgICAgICAgLy8gaXRlcmF0ZSBmaWxlcyBpbiBmb2xkZXJcclxuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZm9sZGVyLmNoaWxkcmVuKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHdlaWdodCA9ICgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGb2xkZXIpIHJldHVybiB0aGlzLnNldHRpbmdzLndlaWdodEZvckZvbGRlciAgICAvLyBkZWZhdWx0IGZvciBmb2xkZXJcclxuICAgICAgICAgICAgICAgIGlmICghKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkgfHwgKGZpbGUuZXh0ZW5zaW9uICE9PSAnbWQnKSkgeyAgLy8gbm90IGZpbGUgb3IgZmlsZSBub3QgLm1kXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0dGluZ3Mud2VpZ2h0Rm9yT3RoZXJGaWxlXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoZmlsZS5uYW1lID09PSAnaW5kZXgubWQnKSB7ICAgICAgICAgICAvLyBpbmRleC5tZCwgc2V0IHdlaWdodCBvZiBmb2xkZXIgaW4gZm9sZGVyLnBhcmVudFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWxlLnBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBvdmVycmlkZSBkZWZhdWx0IHdlaWdodCBvZiBmb2xkZXJcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5maWxlV2VpZ2h0c0J5Rm9sZGVyW2ZpbGUucGFyZW50LnBhdGhdW2ZpbGUucGF0aF0gPSB0aGlzLmdldFdlaWdodE9mTWQoZmlsZSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0dGluZ3Mud2VpZ2h0Rm9ySW5kZXhcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIG5vcm1hbCAubWRcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFdlaWdodE9mTWQoZmlsZSlcclxuICAgICAgICAgICAgfSkoKVxyXG5cclxuICAgICAgICAgICAgLy8gZG9uJ3Qgb3ZlcnJpZGUgZXhpc3Qgd2VpZ2h0KGZvbGRlcilcclxuICAgICAgICAgICAgaWYgKCF3ZWlnaHRCeVBhdGhbZmlsZS5wYXRoXSkgd2VpZ2h0QnlQYXRoW2ZpbGUucGF0aF0gPSB3ZWlnaHRcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2V0V2VpZ2h0T2ZNZChmaWxlOiBURmlsZSkge1xyXG5cclxuICAgICAgICAvLyBhbnkgZmlsZSB3aXRoIGV4dGVuc2lvbiBcIi5tZFwiIG93biBpdHMgY2FjaGVkTWV0YWRhdGEsIGV2ZW4gaXQncyBub3QgYSBtYXJrZG93biBmaWxlICEhIVxyXG4gICAgICAgIC8vIGVtcHR5IG1hcmtkb3duOiBjYWNoZWRNZXRhZGF0YSA9IHt9ICgge30gPSB0cnVlIClcclxuXHJcbiAgICAgICAgY29uc3QgY2FjaGVkTWV0YWRhdGEgPSB0aGlzLmZpbGVFeHBWaWV3LmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKSBhcyBDYWNoZWRNZXRhZGF0YVxyXG4gICAgICAgIGNvbnN0IGZyb250bWF0dGVyID0gY2FjaGVkTWV0YWRhdGEuZnJvbnRtYXR0ZXJcclxuICAgICAgICBpZiAoIWZyb250bWF0dGVyKVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXR0aW5ncy53ZWlnaHRGb3JNYXJrZG93bkZpbGVcclxuXHJcbiAgICAgICAgY29uc3QgcmF3V2VpZ2h0ID0gZnJvbnRtYXR0ZXJbdGhpcy5zZXR0aW5ncy5zb3J0S2V5XVxyXG4gICAgICAgIHJldHVybiBTZXR0aW5nc1V0aWxzLmdldElucHV0T3JEZmx0KFN0cmluZyhyYXdXZWlnaHQpLCAnd2VpZ2h0Rm9yTWFya2Rvd25GaWxlJykgYXMgbnVtYmVyXHJcblxyXG4gICAgfVxyXG5cclxufSJdfQ==